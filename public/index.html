<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>artboard</title>
    <link href="./style.min.css" rel="stylesheet">
  </head>
  <body ontouchstart="">
    <div class="widget">
      <div class="sample sample_default">
        <select class="sample__select" onchange="selectSample(event)">
        </select>
      </div>
      <hr />
      <div class="speak">
        <label for="speak__button" class="speak__label speak__label_default">Type whatever you want in the pink section, then click “Speak it” to hear.</label>
        <label for="speak__button" class="speak__label speak__label_modified" onclick="restoreSamples()">Restore original</label>
        <button name="speak__button" class="speak__button" data-value="Speak It" onclick="handleButtonClick(event)"></button>
      </div>
    </div>
  <script>
    window.onload = generateSamples();

    function selectSample(event) {
      var sample = event.target.parentElement;
      sample.classList.remove('sample_man-1');
      sample.classList.remove('sample_man-2');
      sample.classList.remove('sample_man-3');
      sample.classList.remove('sample_woman-1');
      sample.classList.remove('sample_woman-2');
      sample.classList.remove('sample_woman-3');
      sample.classList.add('sample_' + event.target.value);
      restoreSamples();
    }

    function inputChange(event) {
      var input = event.target;
      var sample = input.parentElement.parentElement;

      if (sample.classList.contains('sample_default')) {
        sample.classList.remove('sample_default');
        sample.classList.add('sample_modified');
      }

      if (input.value.length < 1) {
        input.style.width = '0';
        return;
      }

      var clone = document.createElement('pre');
      clone.classList.add('pre-input');
      clone.innerHTML = input.value;
      sample.parentElement.appendChild(clone);
      input.style.width = clone.offsetWidth + 'px';
      sample.parentElement.removeChild(clone);
    }

    function restoreSamples() {
      var inputEvent = document.createEvent('Event');
      var sampleElement = document.querySelector('.sample');
      var inputs = document.querySelectorAll('.sample__input');

      inputEvent.initEvent('input', false, false);

      for (i = 0; i < inputs.length; i++) {
        inputs[i].value = inputs[i].dataset.value;
        inputs[i].dispatchEvent(inputEvent);
      }

      sampleElement.classList.remove('sample_modified');
      sampleElement.classList.add('sample_default');
    }
    
    function generateSamples() {
      /*var xhr = new XMLHttpRequest();
      xhr.withCredentials = true;
      xhr.open('GET', 'https://public.lyrebird.ai/api/public/sentences');
      xhr.responseType = 'json';
      xhr.send();

      xhr.onload = function() {
        console.log(xhr.response[0]);
      };*/
      var xhr = new XMLHttpRequest();
      // xhr.withCredentials = true;
      xhr.open('GET', './sentences.json');
      xhr.responseType = 'json';
      xhr.send();

      xhr.onload = function() {
        var sampleElement = document.querySelector('.sample');
        var selectElement = sampleElement.firstElementChild;
        var response = xhr.response;

        if (typeof response === "string") {
          response = JSON.parse(response);
        }

        response.forEach(function (item, index) {
          var text = item.text.split(item.text_to_change).map(function (part) {
            if (part !== '') { return part.trim(); }
          });

          sampleElement.insertAdjacentElement('beforeend', createSample({ speaker: item.speaker, text: text, text_to_change: item.text_to_change }));
          selectElement.insertAdjacentElement('beforeend', createOption(item.speaker));

          if (index === 0) {
            sampleElement.classList.add('sample_' + item.speaker.replace(' ', '-'));
          }
        });

        restoreSamples();
      };
    }

    function handleButtonClick(event) {
      var widget = event.target.parentElement.parentElement;

      if (widget.classList.contains('widget_generating')) {
        return;
      } else if (widget.classList.contains('widget_playing')) {
        widget.classList.remove('widget_playing');
      } else {
        widget.classList.add('widget_generating');

        setTimeout(function () {
          widget.classList.remove('widget_generating');
          widget.classList.add('widget_playing');
        }, 1500);
      }
    }

    function createSample(sampleObject) {
      var input = document.createElement('input');
      input.classList.add('sample__input');
      input.addEventListener('input', inputChange);
      input.addEventListener('focus', function (event) { event.target.select() });
      input.type = 'text';
      input.setAttribute('data-value', sampleObject.text_to_change);

      var sampleText = document.createElement('div');
      sampleText.classList.add('sample__text');
      sampleText.classList.add('sample__text_' + sampleObject.speaker.replace(' ', '-'));
      sampleText.insertAdjacentText('beforeend', sampleObject.text[0]);
      sampleText.insertAdjacentElement('beforeend', input);
      sampleObject.text[1] !== undefined &&
        sampleText.insertAdjacentText('beforeend', sampleObject.text[1]);
      return sampleText;
    }

    function createOption(optionText) {
      var option = document.createElement('option');

      option.value = optionText.replace(' ', '-');

      if (optionText.match(/woman\s/)) {
        option.insertAdjacentText('beforeend', optionText.replace(/\bwoman\s/, 'Female Sample #'));
      } else if (optionText.match(/\bman\s/)) {
        option.insertAdjacentText('beforeend', optionText.replace(/\bman\s/, 'Male Sample #'));
      }

      return option;
    }
  </script>
  </body>
</html>
