<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>artboard</title>
    <link href="./style.min.css" rel="stylesheet">
  </head>
  <body ontouchstart="">
    <div id="demo-widget" class="widget">
      <div id="demo-sample" class="sample sample_default">
        <select class="sample__select" onchange="selectSample(event)">
        </select>
      </div>
      <hr />
      <div class="speak">
        <label for="speak__button" class="speak__label speak__label_default">Type whatever you want in the pink section, then click “Speak it” to hear.</label>
        <label for="speak__button" class="speak__label speak__label_modified" onclick="restoreSamples()">Restore original</label>
        <button name="speak__button" class="speak__button" data-value="Speak It" onclick="handleButtonClick(event)"></button>
      </div>
      <audio id="demo-audio" onplay="setStatus('playing')" onended="playAudio()" onerror="playAudio()"></audio>
    </div>
  <script>
    var widget = document.querySelector('#demo-widget');
    var sample = document.querySelector('#demo-sample');
    var audio = document.querySelector('#demo-audio');
    window.onload = generateSamples();

    function selectSample(event) {
      sample.classList.remove('sample_man-1');
      sample.classList.remove('sample_man-2');
      sample.classList.remove('sample_man-3');
      sample.classList.remove('sample_woman-1');
      sample.classList.remove('sample_woman-2');
      sample.classList.remove('sample_woman-3');
      sample.classList.add('sample_' + event.target.value);
      restoreSamples();
    }

    function inputChange(event) {
      var input = event.target;

      if (sample.classList.contains('sample_default')) {
        sample.classList.remove('sample_default');
        sample.classList.add('sample_modified');
      }

      if (input.value.length < 1) {
        input.style.width = '0';
        return;
      }

      var clone = document.createElement('pre');
      clone.classList.add('pre-input');
      clone.innerHTML = input.value;
      widget.appendChild(clone);
      input.style.width = clone.offsetWidth + 'px';
      widget.removeChild(clone);
    }

    function restoreSamples() {
      var inputEvent = document.createEvent('Event');
      var inputs = document.querySelectorAll('.sample__input');

      inputEvent.initEvent('input', false, false);

      for (i = 0; i < inputs.length; i++) {
        inputs[i].value = inputs[i].dataset.value;
        inputs[i].dispatchEvent(inputEvent);
      }

      sample.classList.remove('sample_modified');
      sample.classList.add('sample_default');
    }
    
    function generateSamples() {
      setStatus('generating');
      var get = new XMLHttpRequest();
      get.withCredentials = true;
      get.open('GET', 'https://public.lyrebird.ai/api/public/sentences');
      get.responseType = 'json';
      get.send();
      /*var get = new XMLHttpRequest();
      get.open('GET', './sentences.json');
      get.responseType = 'json';
      get.send();*/

      get.onload = function() {
        var select = sample.firstElementChild;
        var response = get.response;

        if (typeof response === "string") { // specially for chrome on win
          response = JSON.parse(response);  // specially for ie
        }

        response.forEach(function (item, index) {
          var text = item.text.split(item.text_to_change).map(function (part) {
            if (part !== '') { return part.trim(); }
          });

          sample.appendChild(createSample({ speaker: item.speaker, text: text, text_to_change: item.text_to_change }));
          select.appendChild(createOption(item.speaker));

          if (index === 0) {
            sample.classList.add('sample_' + item.speaker.replace(' ', '-'));
          }
        });

        restoreSamples();
        setStatus();
      }
    }

    function handleButtonClick(event) {
      if (
        event.button !== 0
        || widget.classList.contains('widget_generating')
      ) {
        return;
      }

      var sampleName = sample.className.match(/_\w*-\d/)[0].replace('_', '');
      var id = parseInt(sampleName.match(/\d/)[0]);
      var text = document.querySelector('.sample__text_' + sampleName).firstElementChild.value;

      if (widget.classList.contains('widget_playing')) {
        playAudio();
      } else {
        audio.pause(); //  specially for safari
        requestAudio(id, text);
      }
    }

    function createSample(sampleObject) {
      var input = document.createElement('input');
      input.classList.add('sample__input');
      input.addEventListener('input', inputChange);
      input.addEventListener('focus', input.select);
      input.type = 'text';
      input.setAttribute('data-value', sampleObject.text_to_change);

      var sampleText = document.createElement('div');
      sampleText.classList.add('sample__text');
      sampleText.classList.add('sample__text_' + sampleObject.speaker.replace(' ', '-'));
      sampleText.insertAdjacentText('beforeend', sampleObject.text[0]);
      sampleText.insertAdjacentElement('beforeend', input);
      sampleObject.text[1] !== undefined &&
        sampleText.insertAdjacentText('beforeend', sampleObject.text[1]);
      return sampleText;
    }

    function createOption(optionText) {
      var option = document.createElement('option');
      option.value = optionText.replace(' ', '-');

      if (optionText.match(/woman\s/)) {
        option.insertAdjacentText('beforeend', optionText.replace(/\bwoman\s/, 'Female Sample #'));
      } else if (optionText.match(/\bman\s/)) {
        option.insertAdjacentText('beforeend', optionText.replace(/\bman\s/, 'Male Sample #'));
      }

      return option;
    }

    function setStatus(status) {
      widget.classList.remove('widget_generating');
      widget.classList.remove('widget_playing');
      typeof status === 'string' && widget.classList.add('widget_' + status);
    }

    function requestAudio(id, text) {
      setStatus('generating');
      var post = new XMLHttpRequest();
      post.withCredentials = true;
      post.open('POST', 'https://public.lyrebird.ai/api/public/imputation');
      post.responseType = 'json';
      post.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      post.send(JSON.stringify({id: id, text: text}));

      /*var post = new XMLHttpRequest();
      post.withCredentials = true;
      post.open('GET', './response.json');
      post.responseType = 'json';
      post.send();*/

      post.onload = function () {
        var response = post.response;

        if (typeof response === "string") {
          response = JSON.parse(response);
        }

        if (response.audio_url !== undefined) {
          playAudio(response.audio_url);
        } else {
          console.error('Error while fetching URL of audio: ' + response);
        }
      }
    }

    function playAudio(src) {
      if (src === undefined) {
        if (audio.src !== document.URL) {
          audio.currentTime !== 0 && audio.pause();
          audio.src = '';
        }

        setStatus();
        return;
      }

      if (audio.src !== src) {
        audio.src = src;
      }

      audio.play();
    }
  </script>
  </body>
</html>
